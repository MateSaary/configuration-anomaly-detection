apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: cad-check-trigger
  namespace: configuration-anomaly-detection
spec:
  params:
    - name: payload
      value: $(body)
---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerTemplate
metadata:
  name: cad-check-trigger-template
  annotations:
    triggers.tekton.dev/old-escape-quotes: "true"
spec:
  params:
    - name: payload
      description: The event that triggered the webhook.
  resourcetemplates:
    # make sure ./pipeline-run.yaml is the same as this resource here
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        name: cad-check-$(uid)
      spec:
        timeout: 30m
        serviceAccountName: cad-sa
        pipelineRef:
          name: cad-checks-pipeline
        params:
          - name: payload
            value: $(tt.params.payload)

---
apiVersion: triggers.tekton.dev/v1beta1
kind: Trigger
metadata:
  name: cad-pipe-listener
spec:
  interceptors:
    - ref:
        name: "cel"
      params:
      - name: "filter"
        value: "header.canonical('X-Secret-Token').compareSecret('X_SECRET_TOKEN', 'cad-pd-token')"
    # Enable after interceptor deployment is tested
    # - ref:
    #     name: "cad-interceptor"
    #     kind: NamespacedInterceptor
  bindings:
  - ref: cad-check-trigger
  template:
    ref: cad-check-trigger-template
---
# in order to send request to the event listener and test on local crc use:
# curl -X POST --connect-timeout 1 -v --data '{"event": {"id":"12312"}}' http://el-cad-event-listener.ci.svc.cluster.local:8080
apiVersion: triggers.tekton.dev/v1alpha1
kind: EventListener
metadata:
  name: cad-event-listener
  annotations:
    triggers.tekton.dev/old-escape-quotes: "true"
    service.beta.kubernetes.io/load-balancer-source-ranges: 44.242.69.192/32,52.89.71.166/32,54.213.187.133/32,35.86.21.47/32,52.88.94.18/32,44.238.89.29/32,54.241.68.46/32,54.176.72.216/32,54.177.81.67/32,13.56.49.27/32,34.210.57.30/32,34.210.242.134/32,52.34.208.156/32,18.192.91.93/32,18.158.120.237/32,18.194.177.30/32,18.158.199.216/32,3.126.25.87/32,18.197.187.16/32,54.76.3.62/32,54.170.2.90/32,52.213.188.110/32,54.195.179.238/32,34.250.91.200/32,54.76.225.71/32
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
spec:
  triggers:
  - triggerRef: cad-pipe-listener
  resources:
    kubernetesResource:
      serviceType: LoadBalancer
      spec:
        template:
          spec:
            containers:
              - resources:
                  requests:
                    cpu: 100m
                    memory: 64Mi
                  limits:
                    cpu: 500m
                    memory: 256Mi